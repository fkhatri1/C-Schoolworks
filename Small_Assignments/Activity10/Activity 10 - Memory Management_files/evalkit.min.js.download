var evalkit_loaded=0,EvaluationKIT={canvascourseid:null,onLoad:function(){try{if(1===$("#tool_form").length&&"/MyEval/LoginLti.aspx"===$("#tool_form").data("tool-path")&&$("#tool_content").attr("title","Course Evaluations"),window.location.href.indexOf("/login")>-1)return void this.logout();if(!ENV||void 0===ENV)return void console.log("EvaluationKIT : ENV is undefined");if(null===ENV.current_user_id)return;if(!evalkit_setup||void 0===evalkit_setup||0===evalkit_setup.auth_external_tool_id)return void console.log("EvaluationKIT : evalkit_setup is undefined");if("evalkitiframe"===window.name)return;if($("#dashboard").length>0&&!0===evalkit_setup.is_subaccount)return;if($("#dashboard").length>0&&(void 0===evalkit_setup.dash_notify||!1===evalkit_setup.dash_notify))return;if(0===$("#dashboard").length&&0===$(".context_external_tool_"+evalkit_setup.auth_external_tool_id).length&&0===this.getPageCourseId())return;if((evalkit_loaded+=1)>3)return;var a=this.getWSUrlCookie(),b=this.getTokenCookie(),c=this.getVerifyCookie();0===a.length||0===b.length||c!==ENV.current_user_id?this.onLti():this.onUser(b)}catch(a){this.onError(a)}},onLti:function(){!0===evalkit_setup.is_subaccount?ltilaunch="/courses/"+this.getPageCourseId()+"/external_tools/"+evalkit_setup.auth_external_tool_id:ltilaunch="/users/"+ENV.current_user_id+"/external_tools/"+evalkit_setup.auth_external_tool_id,window.addEventListener?window.addEventListener("message",this.onLtiResponse,!1):window.attachEvent("onmessage",this.onLtiResponse),$('<iframe src="'+ltilaunch+'" id="evalkit-lti" name="evalkitiframe" style="display:none;"></iframe>').appendTo($("body"))},onLtiResponse:function(a){if(null!==a.origin&&(-1!==a.origin.toLowerCase().indexOf("eval")||-1!==a.origin.toLowerCase().indexOf("kit"))&&null!==a.data&&void 0!==a.data.length){var b=EvaluationKIT||{};try{var c=JSON.parse(a.data);if(void 0===c)return;var d=c.token;0===d.length&&(d="-1"),b.setWSUrlCookie(c.wsurl),b.setTokenCookie(d),b.setVerifyCookie(ENV.current_user_id)}catch(a){var e=EvaluationKIT||{};e.onError(a)}b.onLoad()}},onSafari:function(){-1!=navigator.userAgent.indexOf("Safari")&&-1===navigator.userAgent.indexOf("Chrome")&&window.open(evalkit_setup.account_url+"/MyEval/CookieSet.aspx","EvalKitSetCookie"+evalkit_setup.auth_external_tool_id,"toolbar=0,location=0,directories=0,status=0,menubar=0,scrollbars=0,resizable=0,width=1,height=1,left=-500")},onUser:function(a){if("-1"!==a){var b=this.getWSUrlCookie(),c=this.getPageCourseId();if(0!==c||!0!==evalkit_setup.is_subaccount)if(0===c)this.getUserSettings(b,a,c,"");else{var d="/api/v1/courses/"+c,e=this.createCORSRequest("GET",d);if(!e)return;e.onload=function(){var d="",f=EvaluationKIT||{};try{d=$.parseJSON(e.responseText).course_code}catch(a){newobjerrnfo.onError(a)}f.getUserSettings(b,a,c,d)},e.onerror=function(d){(EvaluationKIT||{}).onError(d),newobjinfo.getUserSettings(b,a,c,"")},e.send()}}},createCORSRequest:function(a,b){try{var c=new XMLHttpRequest;return"withCredentials"in c?c.open(a,b,!0):"undefined"!=typeof XDomainRequest?(c=new XDomainRequest,c.open(a,b)):c=null,c}catch(a){this.onError(a)}},getUserSettings:function(a,b,c,d){var e=a+"/canvas/usersettings?token="+encodeURIComponent(b)+(c>0?"&courseid="+c+"&coursecode="+encodeURIComponent(d)+"&courseTitle=":""),f=this.createCORSRequest("GET",e);f&&(f.onload=function(){if(401===f.status){(EvaluationKIT||{}).onLti()}else try{var b=$.parseJSON(f.responseText),d=EvaluationKIT||{};d.onPopup(b,c),d.onLinks(b,c)}catch(a){var e=EvaluationKIT||{};e.onError(a)}},f.onerror=function(a){var b=EvaluationKIT||{};navigator.appVersion.indexOf("MSIE 10")>-1||navigator.appVersion.indexOf("MSIE 9")>-1?b.onLti():b.onError(a)},f.send())},onPopup:function(a,b){if(null!==a.popup&&(-1!==window.location.toString().indexOf("/courses/")||0!==$("#dashboard").length)&&(this.endsWith(window.location.toString(),"/courses/"+b)||this.endsWith(window.location.toString(),"/courses/"+b+"/")||0!==$("#dashboard").length||!a.popup.remindlater)&&!(this.endsWith(window.location.toString(),"/external_tools/"+a.studentlink.exttoolid)||this.endsWith(window.location.toString(),"/external_tools/"+a.studentlink.exttoolid+"/")||this.endsWith(window.location.toString(),"/external_tools/"+a.instructorlink.exttoolid)||this.endsWith(window.location.toString(),"/external_tools/"+a.instructorlink.exttoolid+"/")||this.endsWith(window.location.toString(),"/external_tools/"+a.adminlink.exttoolid)||this.endsWith(window.location.toString(),"/external_tools/"+a.adminlink.exttoolid+"/"))&&a.popup.visible){var c=$('<div id="evalkit-popup" />');c.appendTo($("body")),c.html(a.popup.body);var d={},e=a.popup.gotosurveytext,f=a.popup.remindlatertext;e==f&&(f+=" "),d[e]=function(){(EvaluationKIT||{}).onSafari();var c="";a.popup.gotosurvey&&a.popup.externalId>0?c+="/courses/"+a.popup.externalId+"/external_tools/"+a.studentlink.exttoolid:c+="/users/"+ENV.current_user_id+"/external_tools/"+a.userlink.exttoolid,document.location.href=c},a.popup.remindlater&&(d[f]=function(){if(!0===a.popup.incrementDefer){var b=EvaluationKIT||{},c=b.getWSUrlCookie(),d=c+"/canvas/Defer?token="+encodeURIComponent(b.getTokenCookie())+"&projectId="+a.popup.projectId+"&courseId="+a.popup.courseId,e=b.createCORSRequest("GET",d);if(!e)return;e.onerror=function(a){(EvaluationKIT||{}).onError(a)},e.send()}$("#evalkit-popup").dialog("close")}),c.dialog({width:a.popup.width,height:a.popup.height,modal:!0,resizable:!1,draggable:!1,title:a.popup.header,show:"clip",hide:"explode",closeOnEscape:!1,open:function(a,b){var c=$(this).closest(".ui-dialog");c.find(".ui-dialog-titlebar").css({"padding-left":"1em"}).css({"padding-right":"1em"}),c.find(".ui-dialog-titlebar-close").hide()},buttons:d}),this.fixScroll()}},onLinks:function(a,b){this.setLink(a.userlink,b),this.setLink(a.studentlink,b),this.setLink(a.instructorlink,b),this.setLink(a.adminlink,b)},getPageCourseId:function(){return null===this.canvascourseid&&(this.canvascourseid=$("body").attr("class").match(/\bcontext-course_(.[0-9]*)/)?parseInt($("body").attr("class").match(/\bcontext-course_(.[0-9]*)/)[1]):0),this.canvascourseid},getPageCourseCode:function(){return $("#breadcrumbs ul li:nth-child(2) span").text()},getPageUserId:function(){return $("body").attr("class").match(/\bcontext-user_(.[0-9]*)/)?$("body").attr("class").match(/\bcontext-user_(.[0-9]*)/)[1]:""},getRootAccount:function(){return $("#domain_root_account_id").html()},endsWith:function(a,b){return-1!==a.indexOf(b,a.length-b.length)},getWSUrlCookie:function(){return localStorage.getItem("evalkit_wsurl_"+evalkit_setup.auth_external_tool_id)||""},setWSUrlCookie:function(a){localStorage.setItem("evalkit_wsurl_"+evalkit_setup.auth_external_tool_id,a)},getTokenCookie:function(){return localStorage.getItem("evalkit_token_"+evalkit_setup.auth_external_tool_id)||""},setTokenCookie:function(a){localStorage.setItem("evalkit_token_"+evalkit_setup.auth_external_tool_id,a)},getVerifyCookie:function(){return localStorage.getItem("evalkit_verify_"+evalkit_setup.auth_external_tool_id)||""},setVerifyCookie:function(a){localStorage.setItem("evalkit_verify_"+evalkit_setup.auth_external_tool_id,a)},setLink:function(a,b){if(null!==a&&0!==a.exttoolid){var c=$("a.context_external_tool_"+a.exttoolid);2==a.linktype&&0===this.getPageUserId().length||(2==a.linktype&&this.getPageUserId().length>0?a.visible?0===c.length?$("<li class='section evalkitlink'><a style='display:block !important;' class='evalkituser context_external_tool_"+a.exttoolid+"' href='/users/"+ENV.current_user_id+"/external_tools/"+a.exttoolid+"'>"+a.title+"</a></li>").appendTo("#section-tabs"):c.attr("style","display:block !important;"):c.parent().remove():b>0&&(a.visible?0===c.length?$("<li class='section evalkitlink'><a style='display:block !important;' class='evalkitcourse context_external_tool_"+a.exttoolid+"' href='/courses/"+b+"/external_tools/"+a.exttoolid+"'>"+a.title+"</a></li>").appendTo("#section-tabs"):c.attr("style","display:block !important;"):c.parent().remove()),$("a.context_external_tool_"+a.exttoolid).click(function(a){(EvaluationKIT||{}).onSafari()}))}},fixScroll:function(){var a=function(){$("#evalkit-popup").dialog("option","position",["center","center"])};$(window).scroll(function(){a()}),$(window).resize(function(){a()})},logout:function(){this.setTokenCookie(null),this.setWSUrlCookie(null),this.setVerifyCookie(null)},onError:function(a){console.log("EvaluationKIT Canvas User Integration Error: "+a),console.log("EvaluationKIT Canvas User Integration Error Stack: "+a.stack)}};$(document).ready(function(){-1!=navigator.userAgent.indexOf("Safari")&&-1===navigator.userAgent.indexOf("Chrome")&&$(".tool_content_wrapper").css("-webkit-overflow-scrolling","touch").css("overflow-y","scroll"),EvaluationKIT.onLoad()});